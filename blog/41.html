<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2025-05-02 Fri 23:11 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SICP 5.4 The Explicit-Control Evaluator</title>
<meta name="author" content="Giulio" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="./style.css"/>
</head>
<body>
<div id="content" class="content">
<h1 class="title">SICP 5.4 The Explicit-Control Evaluator
<br />
<span class="subtitle">2025-05-02 Fri</span>
</h1>
<p>
Previously we have designed and simulated a stack-and-registers-based
machine to compute factorials, and one to compute fibonaccis.
</p>

<p>
Section 5.4 describes a machine for general purpose computing
(Cf. p. 566). It does so, by translating the metacircular evaluator
&#x2014; a Scheme program which evaluates Scheme expressions &#x2014; into the
controller of a machine with the appropriate data paths (registers and
operations).
</p>

<p>
The metacircular evaluator showed us the general structure of the
evaluation process in terms of <code>eval</code> and <code>apply</code>. The
explicit-control evaluator shows how to translate that in terms of
operations on registers and stacks.
</p>
<blockquote>
<p>
This [&#x2026;] fill[s] in the gap in our understanding of how Scheme
expressions are interpreted, by providing an explicit model for the
mechanisms of control in the evaluator. (p. 492)
</p>
</blockquote>

<p>
We can now see how ``a subexpression manages to return a value to the
expression that uses this value'' (p. 491) and why ``some recursive
procedures generate iterative processes (that is, are evaluated using
constant space) whereas other recursive procedures generate recursive
processes'' (p. 491) &#x2014; a distinction introduced in Chapter 1.
</p>

<p>
Studying the explicit-control evaluator &#x2014; as well the other virtual
machines we have designed &#x2014; is a great exercise in digesting how
real machines operate, since the language of the controller is very
similar to actual Assembly languages.
</p>

<p>
Here is all the code:
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang sicp

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">prompt-for-input</span> string)
  (newline) (newline) (display string) (newline))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">get-global-environment</span>)
  the-global-environment)

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">announce-output</span> string)
  (newline) (display string) (newline))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">user-print</span> object)
  (<span style="color: #531ab6;">if</span> (compound-procedure? object)
      (display (list 'compound-procedure
                     (procedure-parameters object)
                     (procedure-body object)
                     '<span style="color: #005f5f;">&lt;procedure-env&gt;</span>))
      (display object)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">variable?</span> exp) (symbol? exp))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">quoted?</span> exp)
  (tagged-list? exp 'quote))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">assignment?</span> exp)
  (tagged-list? exp 'set!))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">definition?</span> exp)
  (tagged-list? exp 'define))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">if?</span> exp) (tagged-list? exp 'if))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">lambda?</span> exp) (tagged-list? exp 'lambda))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">begin?</span> exp) (tagged-list? exp 'begin))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">application?</span> exp) (pair? exp))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">enclosing-environment</span> env) (cdr env))

(<span style="color: #531ab6;">define</span> <span style="color: #721045;">the-empty-environment</span> '())

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">first-frame</span> env) (car env))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">frame-variables</span> frame) (car frame))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">frame-values</span> frame) (cdr frame))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">lookup-variable-value</span> var env)
  (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">env-loop</span> env)
    (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">scan</span> vars vals)
      (<span style="color: #531ab6;">cond</span> ((null? vars)
             (env-loop (enclosing-environment env)))
            ((eq? var (car vars))
             (car vals))
            (<span style="color: #531ab6;">else</span> (scan (cdr vars) (cdr vals)))))
    (<span style="color: #531ab6;">if</span> (eq? env the-empty-environment)
        (error <span style="color: #3548cf;">"Unbound variable"</span> var)
        (<span style="color: #531ab6;">let</span> ((frame (first-frame env)))
          (scan (frame-variables frame)
                (frame-values frame)))))
  (env-loop env))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">text-of-quotation</span> exp) (cadr exp))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">lambda-parameters</span> exp) (cadr exp))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">lambda-body</span> exp) (cddr exp))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-procedure</span> parameters body env)
  (list 'procedure parameters body env))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">operands</span> exp) (cdr exp))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">operator</span> exp) (car exp))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">first-operand</span> ops) (car ops))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">no-operands?</span> ops) (null? ops))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">rest-operands</span> ops) (cdr ops))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">primitive-procedure?</span> proc)
  (tagged-list? proc 'primitive))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">compound-procedure?</span> p)
  (tagged-list? p 'procedure))

(<span style="color: #531ab6;">define</span> <span style="color: #721045;">apply-in-underlying-scheme</span> apply)

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">primitive-implementation</span> proc) (cadr proc))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">apply-primitive-procedure</span> proc args)
  (apply-in-underlying-scheme
   (primitive-implementation proc) args))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">procedure-parameters</span> p) (cadr p))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">procedure-environment</span> p) (cadddr p))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-frame</span> variables values)
  (cons variables values))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">extend-environment</span> vars vals base-env)
  (<span style="color: #531ab6;">if</span> (= (length vars) (length vals))
      (cons (make-frame vars vals) base-env)
      (<span style="color: #531ab6;">if</span> (&lt; (length vars) (length vals))
          (error <span style="color: #3548cf;">"Too many arguments supplied"</span> vars vals)
          (error <span style="color: #3548cf;">"Too few arguments supplied"</span> vars vals))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">procedure-body</span> p) (caddr p))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">begin-actions</span> exp) (cdr exp))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">first-exp</span> seq) (car seq))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">last-exp?</span> seq) (null? (cdr seq)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">rest-exps</span> seq) (cdr seq))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">if-predicate</span> exp) (cadr exp))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">true?</span> x)
  (not (eq? x false)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">if-alternative</span> exp)
  (<span style="color: #531ab6;">if</span> (not (null? (cdddr exp)))
      (cadddr exp)
      'false))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">if-consequent</span> exp) (caddr exp))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">assignment-variable</span> exp) (cadr exp))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">assignment-value</span> exp) (caddr exp))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">set-variable-value!</span> var val env)
  (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">env-loop</span> env)
    (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">scan</span> vars vals)
      (<span style="color: #531ab6;">cond</span> ((null? vars)
             (env-loop (enclosing-environment env)))
            ((eq? var (car vars))
             (set-car! vals val))
            (<span style="color: #531ab6;">else</span> (scan (cdr vars) (cdr vals)))))
    (<span style="color: #531ab6;">if</span> (eq? env the-empty-environment)
        (error <span style="color: #3548cf;">"Unbound variable -- SET!"</span> var)
        (<span style="color: #531ab6;">let</span> ((frame (first-frame env)))
          (scan (frame-variables frame)
                (frame-values frame)))))
  (env-loop env))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">definition-variable</span> exp)
  (<span style="color: #531ab6;">if</span> (symbol? (cadr exp))
      (cadr exp)
      (caadr exp)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-lambda</span> parameters body)
  (cons 'lambda (cons parameters body)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">definition-value</span> exp)
  (<span style="color: #531ab6;">if</span> (symbol? (cadr exp))
      (caddr exp)
      (make-lambda (cdadr exp)   <span style="color: #595959;">; </span><span style="color: #595959;">formal parameters</span>
                   (cddr exp)))) <span style="color: #595959;">; </span><span style="color: #595959;">body</span>

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">add-binding-to-frame!</span> var val frame)
  (set-car! frame (cons var (car frame)))
  (set-cdr! frame (cons val (cdr frame))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">define-variable!</span> var val env)
  (<span style="color: #531ab6;">let</span> ((frame (first-frame env)))
    (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">scan</span> vars vals)
      (<span style="color: #531ab6;">cond</span> ((null? vars)
             (add-binding-to-frame! var val frame))
            ((eq? var (car vars))
             (set-car! vals val))
            (<span style="color: #531ab6;">else</span> (scan (cdr vars) (cdr vals)))))
    (scan (frame-variables frame)
          (frame-values frame))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">tagged-list?</span> exp tag)
  (<span style="color: #531ab6;">if</span> (pair? exp)
      (eq? (car exp) tag)
      false))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-machine</span> register-names ops controller-text)
  (<span style="color: #531ab6;">let</span> ((machine (make-new-machine)))
    (<span style="color: #531ab6;">for-each</span> (<span style="color: #531ab6;">lambda</span> (register-name)
                ((machine 'allocate-register) register-name))
              register-names)
    ((machine 'install-operations) ops)
    ((machine 'install-instruction-sequence)
     (assemble controller-text machine))
    machine))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-register</span> name)
  (<span style="color: #531ab6;">let</span> ((contents '*unassigned*))
    (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">dispatch</span> message)
      (<span style="color: #531ab6;">cond</span> ((eq? message 'get) contents)
            ((eq? message 'set)
             (<span style="color: #531ab6;">lambda</span> (value) (set! contents value)))
            (<span style="color: #531ab6;">else</span>
             (error <span style="color: #3548cf;">"Unknown request -- REGISTER"</span> message))))
    dispatch))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">get-contents</span> register)
  (register 'get))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">set-contents!</span> register value)
  ((register 'set) value))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-stack</span>)
  (<span style="color: #531ab6;">let</span> ((s '()))
    (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">push</span> x)
      (set! s (cons x s)))
    (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">pop</span>)
      (<span style="color: #531ab6;">if</span> (null? s)
          (error <span style="color: #3548cf;">"Empty stack -- POP"</span>)
          (<span style="color: #531ab6;">let</span> ((top (car s)))
            (set! s (cdr s))
            top)))
    (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">initialize</span>)
      (set! s '())
      'done)
    (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">dispatch</span> message)
      (<span style="color: #531ab6;">cond</span> ((eq? message 'push) push)
            ((eq? message 'pop) (pop))
            ((eq? message 'initialize) (initialize))
            (<span style="color: #531ab6;">else</span> (error <span style="color: #3548cf;">"Unknown request -- STACK"</span>
                         message))))
    dispatch))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">pop</span> stack)
  (stack 'pop))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">push</span> stack value)
  ((stack 'push) value))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-new-machine</span>)
  (<span style="color: #531ab6;">let</span> ((pc (make-register 'pc))
        (flag (make-register 'flag))
        (stack (make-stack))
        (the-instruction-sequence '()))
    (<span style="color: #531ab6;">let</span> ((the-ops
           (list (list 'initialize-stack
                       (<span style="color: #531ab6;">lambda</span> () (stack 'initialize)))))
          (register-table
           (list (list 'pc pc) (list 'flag flag))))
      (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">allocate-register</span> name)
        (<span style="color: #531ab6;">if</span> (assoc name register-table)
            (error <span style="color: #3548cf;">"Multiply defined register: "</span> name)
            (set! register-table
                  (cons (list name (make-register name))
                        register-table)))
        'register-allocated)
      (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">lookup-register</span> name)
        (<span style="color: #531ab6;">let</span> ((val (assoc name register-table)))
          (<span style="color: #531ab6;">if</span> val
              (cadr val)
              (error <span style="color: #3548cf;">"Unknown register:"</span> name))))
      (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">execute</span>)
        (<span style="color: #531ab6;">let</span> ((insts (get-contents pc)))
          (<span style="color: #531ab6;">if</span> (null? insts)
              'done
              (<span style="color: #531ab6;">begin</span>
                ((instruction-execution-proc (car insts)))
                (execute)))))
      (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">dispatch</span> message)
        (<span style="color: #531ab6;">cond</span> ((eq? message 'start)
               (set-contents! pc the-instruction-sequence)
               (execute))
              ((eq? message 'install-instruction-sequence)
               (<span style="color: #531ab6;">lambda</span> (seq) (set! the-instruction-sequence seq)))
              ((eq? message 'allocate-register) allocate-register)
              ((eq? message 'get-register) lookup-register)
              ((eq? message 'install-operations)
               (<span style="color: #531ab6;">lambda</span> (ops) (set! the-ops (append the-ops ops))))
              ((eq? message 'stack) stack)
              ((eq? message 'operations) the-ops)
              (<span style="color: #531ab6;">else</span> (error <span style="color: #3548cf;">"Unknown request -- MACHINE"</span> message))))
      dispatch)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">start</span> machine)
  (machine 'start))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">get-register-contents</span> machine register-name)
  (get-contents (get-register machine register-name)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">set-register-contents!</span> machine register-name value)
  (set-contents! (get-register machine register-name) value)
  'done)

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">get-register</span> machine reg-name)
  ((machine 'get-register) reg-name))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">assemble</span> controller-text machine)
  (<span style="color: #531ab6;">let</span> ((result (extract-labels controller-text)))
    (<span style="color: #531ab6;">let</span> ((insts (car result)) (labels (cdr result)))
      (update-insts! insts labels machine)
      insts)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">extract-labels</span> text)
  (<span style="color: #531ab6;">if</span> (null? text)
      (cons '() '())
      (<span style="color: #531ab6;">let</span> ((result (extract-labels (cdr text))))
        (<span style="color: #531ab6;">let</span> ((insts (car result)) (labels (cdr result)))
          (<span style="color: #531ab6;">let</span> ((next-inst (car text)))
            (<span style="color: #531ab6;">if</span> (symbol? next-inst)
                (cons insts
                      (cons (make-label-entry next-inst insts) labels))
                (cons (cons (make-instruction next-inst) insts)
                      labels)))))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">update-insts!</span> insts labels machine)
  (<span style="color: #531ab6;">let</span> ((pc (get-register machine 'pc))
        (flag (get-register machine 'flag))
        (stack (machine 'stack))
        (ops (machine 'operations)))
    (<span style="color: #531ab6;">for-each</span>
     (<span style="color: #531ab6;">lambda</span> (inst)
       (set-instruction-execution-proc!
        inst
        (make-execution-procedure
         (instruction-text inst) labels machine
         pc flag stack ops)))
     insts)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-instruction</span> text)
  (cons text '()))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">instruction-text</span> inst)
  (car inst))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">instruction-execution-proc</span> inst)
  (cdr inst))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">set-instruction-execution-proc!</span> inst proc)
  (set-cdr! inst proc))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-label-entry</span> label-name insts)
  (cons label-name insts))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">lookup-label</span> labels label-name)
  (<span style="color: #531ab6;">let</span> ((val (assoc label-name labels)))
    (<span style="color: #531ab6;">if</span> val
        (cdr val)
        (error <span style="color: #3548cf;">"Undefined label -- ASSEMBLE"</span> label-name))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-execution-procedure</span> inst labels machine
                                  pc flag stack ops)
  (<span style="color: #531ab6;">cond</span> ((eq? (car inst) 'assign)
         (make-assign inst machine labels ops pc))
        ((eq? (car inst) 'test)
         (make-test inst machine labels ops flag pc))
        ((eq? (car inst) 'branch)
         (make-branch inst machine labels flag pc))
        ((eq? (car inst) 'goto)
         (make-goto inst machine labels pc))
        ((eq? (car inst) 'save)
         (make-save inst machine stack pc))
        ((eq? (car inst) 'restore)
         (make-restore inst machine stack pc))
        ((eq? (car inst) 'perform)
         (make-perform inst machine labels ops pc))
        (<span style="color: #531ab6;">else</span> (error <span style="color: #3548cf;">"Unknown instruction type -- ASSEMBLE"</span>
                     inst))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-assign</span> inst machine labels operations pc)
  (<span style="color: #531ab6;">let</span> ((target
         (get-register machine (assign-reg-name inst)))
        (value-exp (assign-value-exp inst)))
    (<span style="color: #531ab6;">let</span> ((value-proc
           (<span style="color: #531ab6;">if</span> (operation-exp? value-exp)
               (make-operation-exp
                value-exp machine labels operations)
               (make-primitive-exp
                (car value-exp) machine labels))))
      (<span style="color: #531ab6;">lambda</span> ()                <span style="color: #595959;">; </span><span style="color: #595959;">execution procedure for `assign'</span>
        (set-contents! target (value-proc))
        (advance-pc pc)))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">assign-reg-name</span> assign-instruction)
  (cadr assign-instruction))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">assign-value-exp</span> assign-instruction)
  (cddr assign-instruction))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">advance-pc</span> pc)
  (set-contents! pc (cdr (get-contents pc))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-test</span> inst machine labels operations flag pc)
  (<span style="color: #531ab6;">let</span> ((condition (test-condition inst)))
    (<span style="color: #531ab6;">if</span> (operation-exp? condition)
        (<span style="color: #531ab6;">let</span> ((condition-proc
               (make-operation-exp
                condition machine labels operations)))
          (<span style="color: #531ab6;">lambda</span> ()
            (set-contents! flag (condition-proc))
            (advance-pc pc)))
        (error <span style="color: #3548cf;">"Bad TEST instruction -- ASSEMBLE"</span> inst))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">test-condition</span> test-instruction)
  (cdr test-instruction))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-branch</span> inst machine labels flag pc)
  (<span style="color: #531ab6;">let</span> ((dest (branch-dest inst)))
    (<span style="color: #531ab6;">if</span> (label-exp? dest)
        (<span style="color: #531ab6;">let</span> ((insts
               (lookup-label labels (label-exp-label dest))))
          (<span style="color: #531ab6;">lambda</span> ()
            (<span style="color: #531ab6;">if</span> (get-contents flag)
                (set-contents! pc insts)
                (advance-pc pc))))
        (error <span style="color: #3548cf;">"Bad BRANCH instruction -- ASSEMBLE"</span> inst))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">branch-dest</span> branch-instruction)
  (cadr branch-instruction))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-goto</span> inst machine labels pc)
  (<span style="color: #531ab6;">let</span> ((dest (goto-dest inst)))
    (<span style="color: #531ab6;">cond</span> ((label-exp? dest)
           (<span style="color: #531ab6;">let</span> ((insts
                  (lookup-label labels
                                (label-exp-label dest))))
             (<span style="color: #531ab6;">lambda</span> () (set-contents! pc insts))))
          ((register-exp? dest)
           (<span style="color: #531ab6;">let</span> ((reg
                  (get-register machine
                                (register-exp-reg dest))))
             (<span style="color: #531ab6;">lambda</span> ()
               (set-contents! pc (get-contents reg)))))
          (<span style="color: #531ab6;">else</span> (error <span style="color: #3548cf;">"Bad GOTO instruction -- ASSEMBLE"</span>
                       inst)))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">goto-dest</span> goto-instruction)
  (cadr goto-instruction))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-save</span> inst machine stack pc)
  (<span style="color: #531ab6;">let</span> ((reg (get-register machine
                           (stack-inst-reg-name inst))))
    (<span style="color: #531ab6;">lambda</span> ()
      (push stack (get-contents reg))
      (advance-pc pc))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-restore</span> inst machine stack pc)
  (<span style="color: #531ab6;">let</span> ((reg (get-register machine
                           (stack-inst-reg-name inst))))
    (<span style="color: #531ab6;">lambda</span> ()
      (set-contents! reg (pop stack))
      (advance-pc pc))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">stack-inst-reg-name</span> stack-instruction)
  (cadr stack-instruction))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-perform</span> inst machine labels operations pc)
  (<span style="color: #531ab6;">let</span> ((action (perform-action inst)))
    (<span style="color: #531ab6;">if</span> (operation-exp? action)
        (<span style="color: #531ab6;">let</span> ((action-proc
               (make-operation-exp
                action machine labels operations)))
          (<span style="color: #531ab6;">lambda</span> ()
            (action-proc)
            (advance-pc pc)))
        (error <span style="color: #3548cf;">"Bad PERFORM instruction -- ASSEMBLE"</span> inst))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">perform-action</span> inst) (cdr inst))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-primitive-exp</span> exp machine labels)
  (<span style="color: #531ab6;">cond</span> ((constant-exp? exp)
         (<span style="color: #531ab6;">let</span> ((c (constant-exp-value exp)))
           (<span style="color: #531ab6;">lambda</span> () c)))
        ((label-exp? exp)
         (<span style="color: #531ab6;">let</span> ((insts
                (lookup-label labels
                              (label-exp-label exp))))
           (<span style="color: #531ab6;">lambda</span> () insts)))
        ((register-exp? exp)
         (<span style="color: #531ab6;">let</span> ((r (get-register machine
                                (register-exp-reg exp))))
           (<span style="color: #531ab6;">lambda</span> () (get-contents r))))
        (<span style="color: #531ab6;">else</span>
         (error <span style="color: #3548cf;">"Unknown expression type -- ASSEMBLE"</span> exp))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">register-exp?</span> exp) (tagged-list? exp 'reg))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">register-exp-reg</span> exp) (cadr exp))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">constant-exp?</span> exp) (tagged-list? exp 'const))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">constant-exp-value</span> exp) (cadr exp))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">label-exp?</span> exp) (tagged-list? exp 'label))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">label-exp-label</span> exp) (cadr exp))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">make-operation-exp</span> exp machine labels operations)
  (<span style="color: #531ab6;">let</span> ((op (lookup-prim (operation-exp-op exp) operations))
        (aprocs
         (<span style="color: #531ab6;">map</span> (<span style="color: #531ab6;">lambda</span> (e)
                (make-primitive-exp e machine labels))
              (operation-exp-operands exp))))
    (<span style="color: #531ab6;">lambda</span> ()
      (apply op (<span style="color: #531ab6;">map</span> (<span style="color: #531ab6;">lambda</span> (p) (p)) aprocs)))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">operation-exp?</span> exp)
  (<span style="color: #531ab6;">and</span> (pair? exp) (tagged-list? (car exp) 'op)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">operation-exp-op</span> operation-exp)
  (cadr (car operation-exp)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">operation-exp-operands</span> operation-exp)
  (cdr operation-exp))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">lookup-prim</span> symbol operations)
  (<span style="color: #531ab6;">let</span> ((val (assoc symbol operations)))
    (<span style="color: #531ab6;">if</span> val
        (cadr val)
        (error <span style="color: #3548cf;">"Unknown operation -- ASSEMBLE"</span> symbol))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">self-evaluating?</span> exp)
  (<span style="color: #531ab6;">cond</span> ((number? exp) true)
        ((string? exp) true)
        (<span style="color: #531ab6;">else</span> false)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">last-operand?</span> ops)
  (null? (cdr ops)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">empty-arglist</span>) '())

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">adjoin-arg</span> arg arglist)
  (append arglist (list arg)))

(<span style="color: #531ab6;">define</span> <span style="color: #721045;">eceval-operations</span>
  (list (list 'self-evaluating? self-evaluating?)
        (list 'empty-arglist empty-arglist)
        (list 'prompt-for-input prompt-for-input)
        (list 'read read)
        (list 'get-global-environment get-global-environment)
        (list 'announce-output announce-output)
        (list 'user-print user-print)
        (list 'variable? variable?)
        (list 'quoted? quoted?)
        (list 'assignment? assignment?)
        (list 'definition? definition?)
        (list 'if? if?)
        (list 'lambda? lambda?)
        (list 'begin? begin?)
        (list 'application? application?)        
        (list 'lookup-variable-value lookup-variable-value)
        (list 'text-of-quotation text-of-quotation)
        (list 'lambda-parameters lambda-parameters)
        (list 'lambda-body lambda-body)
        (list 'make-procedure make-procedure)
        (list 'operands operands)
        (list 'operator operator)
        (list 'first-operand first-operand)
        (list 'no-operands? no-operands?)
        (list 'last-operand? last-operand?)
        (list 'adjoin-arg adjoin-arg)
        (list 'rest-operands rest-operands)
        (list 'primitive-procedure? primitive-procedure?)
        (list 'compound-procedure? compound-procedure?)
        (list 'apply-primitive-procedure apply-primitive-procedure)
        (list 'procedure-parameters procedure-parameters)
        (list 'procedure-environment procedure-environment)
        (list 'extend-environment extend-environment)
        (list 'procedure-body procedure-body)
        (list 'begin-actions begin-actions)
        (list 'first-exp first-exp)
        (list 'last-exp? last-exp?)
        (list 'rest-exps rest-exps)
        (list 'if-predicate if-predicate)
        (list 'true? true?)
        (list 'if-alternative if-alternative)
        (list 'if-consequent if-consequent)
        (list 'assignment-variable assignment-variable)
        (list 'assignment-value assignment-value)
        (list 'set-variable-value! set-variable-value!)
        (list 'definition-variable definition-variable)
        (list 'definition-value definition-value)
        (list 'define-variable! define-variable!)))

(<span style="color: #531ab6;">define</span> <span style="color: #721045;">eceval</span>
  (make-machine
   '(exp env val proc argl continue unev)
   eceval-operations
   '(
     read-eval-print-loop
     (perform (op initialize-stack))
     (perform
      (op prompt-for-input) (const <span style="color: #3548cf;">";;; EC-Eval input:"</span>))
     (assign exp (op read))
     (assign env (op get-global-environment))
     (assign continue (label print-result))
     (goto (label eval-dispatch))
     print-result
     (perform
      (op announce-output) (const <span style="color: #3548cf;">";;; EC-Eval value:"</span>))
     (perform (op user-print) (reg val))
     (goto (label read-eval-print-loop))

     unknown-expression-type
     (assign val (const unknown-expression-type-error))
     (goto (label signal-error))

     unknown-procedure-type
     (restore continue)    <span style="color: #595959;">; </span><span style="color: #595959;">clean up stack (from `apply-dispatch')</span>
     (assign val (const unknown-procedure-type-error))
     (goto (label signal-error))

     signal-error
     (perform (op user-print) (reg val))
     (goto (label read-eval-print-loop))

     eval-dispatch
     (test (op self-evaluating?) (reg exp))
     (branch (label ev-self-eval))
     (test (op variable?) (reg exp))
     (branch (label ev-variable))
     (test (op quoted?) (reg exp))
     (branch (label ev-quoted))
     (test (op assignment?) (reg exp))
     (branch (label ev-assignment))
     (test (op definition?) (reg exp))
     (branch (label ev-definition))
     (test (op if?) (reg exp))
     (branch (label ev-if))
     (test (op lambda?) (reg exp))
     (branch (label ev-lambda))
     (test (op begin?) (reg exp))
     (branch (label ev-begin))
     (test (op application?) (reg exp))
     (branch (label ev-application))
     (goto (label unknown-expression-type))

     ev-self-eval
     (assign val (reg exp))
     (goto (reg continue))
     ev-variable
     (assign val (op lookup-variable-value) (reg exp) (reg env))
     (goto (reg continue))
     ev-quoted
     (assign val (op text-of-quotation) (reg exp))
     (goto (reg continue))
     ev-lambda
     (assign unev (op lambda-parameters) (reg exp))
     (assign exp (op lambda-body) (reg exp))
     (assign val (op make-procedure)
             (reg unev) (reg exp) (reg env))
     (goto (reg continue))

     ev-application
     (save continue)
     (save env)
     (assign unev (op operands) (reg exp))
     (save unev)
     (assign exp (op operator) (reg exp))
     (assign continue (label ev-appl-did-operator))
     (goto (label eval-dispatch))

     ev-appl-did-operator
     (restore unev)                  <span style="color: #595959;">; </span><span style="color: #595959;">the operands</span>
     (restore env)
     (assign argl (op empty-arglist))
     (assign proc (reg val))         <span style="color: #595959;">; </span><span style="color: #595959;">the operator</span>
     (test (op no-operands?) (reg unev))
     (branch (label apply-dispatch))
     (save proc)

     ev-appl-operand-loop
     (save argl)
     (assign exp (op first-operand) (reg unev))
     (test (op last-operand?) (reg unev))
     (branch (label ev-appl-last-arg))
     (save env)
     (save unev)
     (assign continue (label ev-appl-accumulate-arg))
     (goto (label eval-dispatch))

     ev-appl-accumulate-arg
     (restore unev)
     (restore env)
     (restore argl)
     (assign argl (op adjoin-arg) (reg val) (reg argl))
     (assign unev (op rest-operands) (reg unev))
     (goto (label ev-appl-operand-loop))

     ev-appl-last-arg
     (assign continue (label ev-appl-accum-last-arg))
     (goto (label eval-dispatch))
     ev-appl-accum-last-arg
     (restore argl)
     (assign argl (op adjoin-arg) (reg val) (reg argl))
     (restore proc)
     (goto (label apply-dispatch))

     apply-dispatch
     (test (op primitive-procedure?) (reg proc))
     (branch (label primitive-apply))
     (test (op compound-procedure?) (reg proc))
     (branch (label compound-apply))
     (goto (label unknown-procedure-type))

     primitive-apply
     (assign val (op apply-primitive-procedure)
             (reg proc)
             (reg argl))
     (restore continue)
     (goto (reg continue))

     compound-apply
     (assign unev (op procedure-parameters) (reg proc))
     (assign env (op procedure-environment) (reg proc))
     (assign env (op extend-environment)
             (reg unev) (reg argl) (reg env))
     (assign unev (op procedure-body) (reg proc))
     (goto (label ev-sequence))


     ev-begin
     (assign unev (op begin-actions) (reg exp))
     (save continue)
     (goto (label ev-sequence))

     ev-sequence
     (assign exp (op first-exp) (reg unev))
     (test (op last-exp?) (reg unev))
     (branch (label ev-sequence-last-exp))
     (save unev)
     (save env)
     (assign continue (label ev-sequence-continue))
     (goto (label eval-dispatch))
     ev-sequence-continue
     (restore env)
     (restore unev)
     (assign unev (op rest-exps) (reg unev))
     (goto (label ev-sequence))
     ev-sequence-last-exp
     (restore continue)
     (goto (label eval-dispatch))
     <span style="color: #595959;">;; </span><span style="color: #595959;">check different implementation in the book</span>


     ev-if
     (save exp)                    <span style="color: #595959;">; </span><span style="color: #595959;">save expression for later</span>
     (save env)
     (save continue)
     (assign continue (label ev-if-decide))
     (assign exp (op if-predicate) (reg exp))
     (goto (label eval-dispatch))  <span style="color: #595959;">; </span><span style="color: #595959;">evaluate the predicate</span>

     ev-if-decide
     (restore continue)
     (restore env)
     (restore exp)
     (test (op true?) (reg val))
     (branch (label ev-if-consequent))

     ev-if-alternative
     (assign exp (op if-alternative) (reg exp))
     (goto (label eval-dispatch))
     ev-if-consequent
     (assign exp (op if-consequent) (reg exp))
     (goto (label eval-dispatch))

     ev-assignment
     (assign unev (op assignment-variable) (reg exp))
     (save unev)                   <span style="color: #595959;">; </span><span style="color: #595959;">save variable for later</span>
     (assign exp (op assignment-value) (reg exp))
     (save env)
     (save continue)
     (assign continue (label ev-assignment-1))
     (goto (label eval-dispatch))  <span style="color: #595959;">; </span><span style="color: #595959;">evaluate the assignment value</span>
     ev-assignment-1
     (restore continue)
     (restore env)
     (restore unev)
     (perform
      (op set-variable-value!) (reg unev) (reg val) (reg env))
     (assign val (const ok))
     (goto (reg continue))

     ev-definition
     (assign unev (op definition-variable) (reg exp))
     (save unev)                   <span style="color: #595959;">; </span><span style="color: #595959;">save variable for later</span>
     (assign exp (op definition-value) (reg exp))
     (save env)
     (save continue)
     (assign continue (label ev-definition-1))
     (goto (label eval-dispatch))  <span style="color: #595959;">; </span><span style="color: #595959;">evaluate the definition value</span>
     ev-definition-1
     (restore continue)
     (restore env)
     (restore unev)
     (perform
      (op define-variable!) (reg unev) (reg val) (reg env))
     (assign val (const ok))
     (goto (reg continue)))))

(<span style="color: #531ab6;">define</span> <span style="color: #721045;">primitive-procedures</span>
  (list (list 'car car)
        (list 'cdr cdr)
        (list 'cons cons)
        (list 'null? null?)
        (list '= =)
        (list '+ +)
        (list '- -)
        (list '* *)
        (list '/ /)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">primitive-procedure-names</span>)
  (<span style="color: #531ab6;">map</span> car
       primitive-procedures))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">primitive-procedure-objects</span>)
  (<span style="color: #531ab6;">map</span> (<span style="color: #531ab6;">lambda</span> (proc) (list 'primitive (cadr proc)))
       primitive-procedures))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">setup-environment</span>)
  (<span style="color: #531ab6;">let</span> ((initial-env
         (extend-environment (primitive-procedure-names)
                             (primitive-procedure-objects)
                             the-empty-environment)))
    (define-variable! 'true true initial-env)
    (define-variable! 'false false initial-env)
    initial-env))

(<span style="color: #531ab6;">define</span> <span style="color: #721045;">the-global-environment</span> (setup-environment))

(start eceval)
</pre>
</div>
<div id="outline-container-org438bd28" class="outline-2">
<h2 id="org438bd28">Exercise 5.23</h2>
<div class="outline-text-2" id="text-org438bd28">
<p>
<b>Exercise</b>:
</p>

<blockquote>
<p>
Extend the evaluator to handle derived expressions such as `cond',
`let', and so on (section *Note 4-1-2::).  You may "cheat" and assume
that the syntax transformers such as `cond-&gt;if' are available as
machine operations. (fn: This isn't really cheating.  In an actual
implementation built from scratch, we would use our explicit-control
evaluator to interpret a Scheme program that performs source-level
transformations like `cond-&gt;if' in a syntax phase that runs before
execution.)
</p>
</blockquote>

<p>
<b>Answer</b>:
</p>

<p>
In order to add support for <code>let</code>, I have:
</p>

<ul class="org-ul">
<li><p>
Defined <code>cond?</code> and <code>cond-&gt;if</code>:
</p>
<div class="org-src-container">
<pre class="src src-racket">(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">cond?</span> <span style="color: #8f0075;">exp</span>) (tagged-list? <span style="color: #8f0075;">exp</span> <span style="color: #0000b0;">'cond</span>))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">cond-clauses</span> <span style="color: #8f0075;">exp</span>) (<span style="color: #8f0075;">cdr</span> <span style="color: #8f0075;">exp</span>))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">cond-else-clause?</span> clause)
  (<span style="color: #8f0075;">eq?</span> (cond-predicate clause) <span style="color: #0000b0;">'else</span>))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">cond-predicate</span> clause) (<span style="color: #8f0075;">car</span> clause))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">cond-actions</span> clause) (<span style="color: #8f0075;">cdr</span> clause))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">cond-&gt;if</span> <span style="color: #8f0075;">exp</span>)
  (expand-clauses (cond-clauses <span style="color: #8f0075;">exp</span>)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">expand-clauses</span> clauses)
  (<span style="color: #531ab6;">if</span> (<span style="color: #8f0075;">null?</span> clauses)
      <span style="color: #0000b0;">'false</span>                          <span style="color: #595959;">; </span><span style="color: #595959;">no `else' clause</span>
      (<span style="color: #531ab6;">let</span> ((<span style="color: #005e8b;">first</span> (<span style="color: #8f0075;">car</span> clauses))
            (<span style="color: #005e8b;">rest</span> (<span style="color: #8f0075;">cdr</span> clauses)))
        (<span style="color: #531ab6;">if</span> (cond-else-clause? <span style="color: #8f0075;">first</span>)
            (<span style="color: #531ab6;">if</span> (<span style="color: #8f0075;">null?</span> <span style="color: #8f0075;">rest</span>)
                (sequence-&gt;exp (cond-actions <span style="color: #8f0075;">first</span>))
                (<span style="color: #8f0075;">error</span> <span style="color: #3548cf;">"ELSE clause isn't last -- COND-&gt;IF"</span>
                       clauses))
            (make-if (cond-predicate <span style="color: #8f0075;">first</span>)
                     (sequence-&gt;exp (cond-actions <span style="color: #8f0075;">first</span>))
                     (expand-clauses <span style="color: #8f0075;">rest</span>))))))
</pre>
</div></li>

<li><p>
Added <code>cond?</code> and <code>cond-&gt;if</code> to the <code>eceval-operations</code>:
</p>
<div class="org-src-container">
<pre class="src src-racket">(<span style="color: #531ab6;">define</span> <span style="color: #005e8b;">eceval-operations</span>
  (<span style="color: #8f0075;">list</span> (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'self-evaluating?</span> self-evaluating?)
        (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'empty-arglist</span> empty-arglist)
        <span style="color: #595959;">;; </span><span style="color: #595959;">...</span>
        (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'cond?</span> cond?)
        (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'cond-&gt;if</span> cond-&gt;if)
        <span style="color: #595959;">;; </span><span style="color: #595959;">...</span>
        (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'define-variable!</span> define-variable!)))
</pre>
</div></li>

<li><p>
Added a <code>test</code> instruction and a <code>branch</code> instruction to the
<code>eval-dispatch</code> section in the controller text:
</p>
<div class="org-src-container">
<pre class="src src-racket">eval-dispatch
  (test (op self-evaluating?) (reg <span style="color: #8f0075;">exp</span>))
  (branch (label ev-self-eval))
  <span style="color: #595959;">;; </span><span style="color: #595959;">...</span>
  (test (op cond?) (reg <span style="color: #8f0075;">exp</span>))
  (branch (label ev-cond))
  <span style="color: #595959;">;; </span><span style="color: #595959;">...</span>
  (branch (label ev-application))
  (goto (label unknown-expression-type))
</pre>
</div></li>

<li><p>
Added an <code>ev-cond</code> section in the controller text:
</p>
<div class="org-src-container">
<pre class="src src-racket">ev-sequence
  <span style="color: #595959;">;; </span><span style="color: #595959;">...</span>

ev-cond
  (assign <span style="color: #8f0075;">exp</span> (op cond-&gt;if) (reg <span style="color: #8f0075;">exp</span>))
  (goto (label eval-dispatch))

ev-if
  <span style="color: #595959;">;; </span><span style="color: #595959;">...</span>
</pre>
</div></li>
</ul>

<p>
I have done the same, mutatis mutandis, in order to add support for
<code>let</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket">(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">let?</span> <span style="color: #721045;">exp</span>) (tagged-list? <span style="color: #8f0075;">exp</span> <span style="color: #0000b0;">'let</span>))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">let-vars</span> <span style="color: #721045;">exp</span>)
  (<span style="color: #8f0075;">map</span> <span style="color: #8f0075;">car</span> (<span style="color: #8f0075;">cadr</span> <span style="color: #8f0075;">exp</span>)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">let-exps</span> <span style="color: #721045;">exp</span>)
  (<span style="color: #8f0075;">map</span> <span style="color: #8f0075;">cadr</span> (<span style="color: #8f0075;">cadr</span> <span style="color: #8f0075;">exp</span>)))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">let-body</span> <span style="color: #721045;">exp</span>)
  (<span style="color: #8f0075;">cddr</span> <span style="color: #8f0075;">exp</span>))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">named-let-&gt;combination</span> <span style="color: #8f0075;">exp</span>)
  (<span style="color: #531ab6;">let</span> ((<span style="color: #005e8b;">nameless</span> (<span style="color: #8f0075;">cons</span> (<span style="color: #8f0075;">car</span> <span style="color: #8f0075;">exp</span>) (<span style="color: #8f0075;">cddr</span> <span style="color: #8f0075;">exp</span>)))
        (<span style="color: #005e8b;">name</span> (<span style="color: #8f0075;">cadr</span> <span style="color: #8f0075;">exp</span>)))

    (<span style="color: #8f0075;">cons</span> <span style="color: #0000b0;">'begin</span> (<span style="color: #8f0075;">list</span> (<span style="color: #8f0075;">cons</span> <span style="color: #0000b0;">'define</span>
                             (<span style="color: #8f0075;">cons</span> (<span style="color: #8f0075;">cons</span> name (let-vars <span style="color: #721045;">nameless</span>))
                                   (let-body <span style="color: #721045;">nameless</span>)))
                       (<span style="color: #8f0075;">cons</span> name (let-exps <span style="color: #721045;">nameless</span>))))))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">let-&gt;combination</span> <span style="color: #721045;">exp</span>)
  (<span style="color: #531ab6;">if</span> (<span style="color: #8f0075;">not</span> (<span style="color: #8f0075;">pair?</span> (<span style="color: #8f0075;">cadr</span> <span style="color: #8f0075;">exp</span>)))
      (named-let-&gt;combination <span style="color: #8f0075;">exp</span>)
      (<span style="color: #8f0075;">cons</span> (<span style="color: #8f0075;">cons</span> <span style="color: #0000b0;">'lambda</span>
                  (<span style="color: #8f0075;">cons</span> (let-vars <span style="color: #721045;">exp</span>)
                        (let-body <span style="color: #721045;">exp</span>)))
            (let-exps <span style="color: #721045;">exp</span>))))

(<span style="color: #531ab6;">define</span> <span style="color: #005e8b;">eceval-operations</span>
  (<span style="color: #8f0075;">list</span> (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'self-evaluating?</span> self-evaluating?)
        <span style="color: #595959;">;; </span><span style="color: #595959;">...</span>
        (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'let?</span> let?)
        (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'let-&gt;combination</span> let-&gt;combination)
        <span style="color: #595959;">;; </span><span style="color: #595959;">...</span>
        (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'define-variable!</span> define-variable!)))

(<span style="color: #531ab6;">define</span> <span style="color: #005e8b;">eceval</span>
  (make-machine
   '(<span style="color: #8f0075;">exp</span> env val proc argl continue unev)
   eceval-operations
   '(
     <span style="color: #595959;">;; </span><span style="color: #595959;">...</span>

     eval-dispatch
       (test (op self-evaluating?) (reg <span style="color: #8f0075;">exp</span>))
       (branch (label ev-self-eval))
       (test (op variable?) (reg <span style="color: #8f0075;">exp</span>))
       (branch (label ev-variable))
       (test (op quoted?) (reg <span style="color: #8f0075;">exp</span>))
       (branch (label ev-quoted))
       (test (op assignment?) (reg <span style="color: #8f0075;">exp</span>))
       (branch (label ev-assignment))
       (test (op definition?) (reg <span style="color: #8f0075;">exp</span>))
       (branch (label ev-definition))
       (test (op if?) (reg <span style="color: #8f0075;">exp</span>))
       (branch (label ev-if))
       (test (op cond?) (reg <span style="color: #8f0075;">exp</span>))
       (branch (label ev-cond))
       (test (op let?) (reg <span style="color: #8f0075;">exp</span>))
       (branch (label ev-let))
       (test (op lambda?) (reg <span style="color: #8f0075;">exp</span>))
       (branch (label ev-lambda))
       (test (op begin?) (reg <span style="color: #8f0075;">exp</span>))
       (branch (label ev-begin))
       (test (op application?) (reg <span style="color: #8f0075;">exp</span>))
       (branch (label ev-application))
       (goto (label unknown-expression-type))

     <span style="color: #595959;">;; </span><span style="color: #595959;">...</span>

     ev-let
       (assign <span style="color: #8f0075;">exp</span> (op let-&gt;combination) (reg <span style="color: #8f0075;">exp</span>))
       (goto (label eval-dispatch))

     <span style="color: #595959;">;; </span><span style="color: #595959;">...</span>
     )))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgddfd3af" class="outline-2">
<h2 id="orgddfd3af">Exercise 5.24</h2>
<div class="outline-text-2" id="text-orgddfd3af">
<p>
<b>Exercise</b>:
</p>

<blockquote>
<p>
Implement <code>cond</code> as a new basic special form without reducing it to
<code>if</code>.  You will have to construct a loop that tests the predicates of
successive <code>cond</code> clauses until you find one that is true, and then
use <code>ev-sequence</code> to evaluate the actions of the clause.
</p>
</blockquote>

<p>
<b>Answer</b>:
</p>

<p>
I have:
</p>

<ul class="org-ul">
<li><p>
Defined (and added to the machine) some operations:
</p>

<div class="org-src-container">
<pre class="src src-racket">(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">cond?</span> <span style="color: #8f0075;">exp</span>) (tagged-list? <span style="color: #8f0075;">exp</span> <span style="color: #0000b0;">'cond</span>))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">cond-clauses</span> <span style="color: #8f0075;">exp</span>) (<span style="color: #8f0075;">cdr</span> <span style="color: #8f0075;">exp</span>))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">cond-predicate</span> clause) (<span style="color: #8f0075;">car</span> clause))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">cond-actions</span> clause) (<span style="color: #8f0075;">cdr</span> clause))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">cond-first-clause</span> clauses)
  (<span style="color: #8f0075;">car</span> clauses))

(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">cond-rest-clauses</span> clauses)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket">(<span style="color: #531ab6;">define</span> <span style="color: #005e8b;">eceval-operations</span>
  (<span style="color: #8f0075;">list</span> (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'self-evaluating?</span> self-evaluating?)
        <span style="color: #595959;">;; </span><span style="color: #595959;">...</span>
        (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'cond?</span> cond?)
        (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'cond-clauses</span> cond-clauses)
        (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'cond-first-clause</span> cond-first-clause)
        (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'cond-rest-clauses</span> cond-rest-clauses)
        (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'cond-predicate</span> cond-predicate)
        (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'cond-actions</span> cond-actions)
        <span style="color: #595959;">;; </span><span style="color: #595959;">...</span>
        (<span style="color: #8f0075;">list</span> <span style="color: #0000b0;">'define-variable!</span> define-variable!)))
</pre>
</div></li>

<li><p>
Updated the controller:
</p>
<div class="org-src-container">
<pre class="src src-racket">ev-cond
  (assign <span style="color: #8f0075;">exp</span> (op cond-clauses) (reg <span style="color: #8f0075;">exp</span>)) <span style="color: #595959;">;; </span><span style="color: #595959;">get rid of cond tag</span>
  (save env) <span style="color: #595959;">;; </span><span style="color: #595959;">FIXME should I save the env in the loop?</span>
  (save continue)
ev-cond-loop
  (save <span style="color: #8f0075;">exp</span>) <span style="color: #595959;">;; </span><span style="color: #595959;">save clauses for later</span>

  <span style="color: #595959;">;; </span><span style="color: #595959;">FIXME should I add a check for the else clause?</span>

  <span style="color: #595959;">;; </span><span style="color: #595959;">FIXME should I add a check for the case in which the clauses are an empty list?</span>

  (assign continue (label ev-cond-decide))
  (assign <span style="color: #8f0075;">exp</span> (op cond-first-clause) (reg <span style="color: #8f0075;">exp</span>)) <span style="color: #595959;">;; </span><span style="color: #595959;">put predicate of first clause</span>
  (assign <span style="color: #8f0075;">exp</span> (op cond-predicate) (reg <span style="color: #8f0075;">exp</span>))    <span style="color: #595959;">;; </span><span style="color: #595959;">in exp</span>
  (goto (label eval-dispatch))

ev-cond-decide
  (restore <span style="color: #8f0075;">exp</span>)
  (test (op true?) (reg val))
  (branch (label ev-cond-actions))
  (assign <span style="color: #8f0075;">exp</span> (op cond-rest-clauses) (reg <span style="color: #8f0075;">exp</span>))
  (goto (label ev-cond-loop))

ev-cond-actions
  (restore continue)
  (restore env)
  (assign unev (op cond-first-clause) (reg <span style="color: #8f0075;">exp</span>)) <span style="color: #595959;">;; </span><span style="color: #595959;">put clause's actions</span>
  (assign unev (op cond-actions) (reg unev))     <span style="color: #595959;">;; </span><span style="color: #595959;">in unev</span>
  (save continue) <span style="color: #595959;">;; </span><span style="color: #595959;">cf. ev-begin...</span>
  (goto (label ev-sequence))
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgacef6e8" class="outline-2">
<h2 id="orgacef6e8">Exercise 5.26</h2>
<div class="outline-text-2" id="text-orgacef6e8">
<p>
<b>Exercise</b>:
</p>
<blockquote>
<p>
Use the monitored stack to explore the tail-recursive property of the
evaluator (section 5-4-2).  Start the evaluator and define the
iterative <code>factorial</code> procedure from section 1.2.1
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">factorial</span> n)
  (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">iter</span> product counter)
    (<span style="color: #531ab6;">if</span> (&gt; counter n)
        product
        (iter (* counter product)
              (+ counter 1))))
  (iter 1 1))
</pre>
</div>

<p>
Run the procedure with some small values of n.  Record the maximum
stack depth and the number of pushes required to compute n! for
each of these values.
</p>

<p>
a. You will find that the maximum depth required to evaluate n!  is
independent of n.  What is that depth?
</p>

<p>
b. Determine from your data a formula in terms of n for the
total number of push operations used in evaluating n! for any
n &gt;= 1.  Note that the number of operations used is a linear
function of n and is thus determined by two constants.
</p>
</blockquote>

<p>
<b>Answer</b>:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">factorial</span> n)
  (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">iter</span> product counter)
    (<span style="color: #531ab6;">if</span> (<span style="color: #8f0075;">&gt;</span> counter n)
        product
        (iter (<span style="color: #8f0075;">*</span> counter product)
              (<span style="color: #8f0075;">+</span> counter <span style="color: #0000b0;">1</span>))))
  (iter <span style="color: #0000b0;">1</span> <span style="color: #0000b0;">1</span>))


(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">3</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">3</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
ok

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">1</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">64</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">10</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">1</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">2</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">99</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">10</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">2</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">3</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">134</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">10</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">6</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">4</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">169</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">10</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">24</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">6</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">239</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">10</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">720</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">9</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">344</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">10</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">362880</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">12</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">449</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">10</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">479001600</span>
</pre>
</div>

<p>
a: The depth is 10.
</p>

<p>
b: The difference between the stack operations needed for <code>n!</code> and
those needed for <code>(n+1)!</code> is 35.
</p>

<p>
The linear function can be written in the form <code>ops(n!) = a * n + b</code>,
where <code>a</code> is the rate at which operations increase (the slope) and <code>b</code>
is the base number of operations.
</p>

<p>
We know that <code>a</code> is 35.
</p>

<p>
By substituting we can find the value of <code>b</code>, which is 29.
</p>

<p>
So, this should be the formula: <code>ops(n!) = 35n + 29</code>.
</p>
</div>
</div>
<div id="outline-container-org81e7c0e" class="outline-2">
<h2 id="org81e7c0e">Exercise 5.27</h2>
<div class="outline-text-2" id="text-org81e7c0e">
<p>
<b>Exercise</b>:
</p>

<blockquote>
<p>
For comparison with exercise 5.26, explore the behavior of the
following procedure for computing factorials recursively:
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">factorial</span> n)
  (<span style="color: #531ab6;">if</span> (= n 1)
      1
      (* (factorial (- n 1)) n)))
</pre>
</div>

<p>
By running this procedure with the monitored stack, determine, as
a function of n, the maximum depth of the stack and the total
number of pushes used in evaluating n! for n &gt;= 1.  (Again, these
functions will be linear.)  Summarize your experiments by filling
in the following table with the appropriate expressions in terms
of n:
</p>

<p>
Maximum depth       Number of pushes
</p>

<p>
Recursive
factorial
</p>

<p>
Iterative
factorial
</p>

<p>
The maximum depth is a measure of the amount of space used by the
evaluator in carrying out the computation, and the number of pushes
correlates well with the time required.
</p>
</blockquote>

<p>
<b>Answer</b>:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #595959;">;; </span><span style="color: #595959;">monitoring the recursive factorial</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">factorial</span> n)
  (<span style="color: #531ab6;">if</span> (<span style="color: #8f0075;">=</span> n <span style="color: #0000b0;">1</span>)
      <span style="color: #0000b0;">1</span>
      (<span style="color: #8f0075;">*</span> (factorial (<span style="color: #8f0075;">-</span> n <span style="color: #0000b0;">1</span>)) n)))

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">3</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">3</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
ok

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">1</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">16</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">8</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">1</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">2</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">48</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">13</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">2</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">3</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">80</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">18</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">6</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">4</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">112</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">23</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">24</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">5</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">144</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">28</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">120</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">6</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">176</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">33</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">720</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">7</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">208</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">38</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">5040</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">8</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">240</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">43</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">40320</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">9</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">272</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">48</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">362880</span>
</pre>
</div>

<ul class="org-ul">
<li>recursive factorial:
<ul class="org-ul">
<li>number of pushes:
<ul class="org-ul">
<li><code>ops(n!) = 32 * n + 16</code></li>
</ul></li>
<li>Max depth:
<ul class="org-ul">
<li><code>max_depth(n!) = 5 * n + 3</code></li>
</ul></li>
</ul></li>
</ul>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">Maximum depth</th>
<th scope="col" class="org-left">Number of pushes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">recursive</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">w</td>
</tr>

<tr>
<td class="org-left">factorial</td>
<td class="org-left">5 * n + 3</td>
<td class="org-left">32 * n + 16</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Iterative</td>
<td class="org-left">10</td>
<td class="org-left">35 * n + 29</td>
</tr>

<tr>
<td class="org-left">factorial</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-orgb696cca" class="outline-2">
<h2 id="orgb696cca">Exercise 5.28</h2>
<div class="outline-text-2" id="text-orgb696cca">
<p>
<b>Exercise</b>:
</p>

<blockquote>
<p>
Modify the definition of the evaluator by changing <code>eval-sequence</code> as
described in section 5.4.2 so that the evaluator is no longer
tail-recursive.  Rerun your experiments from Exercise 5.26 and
Exercise 5.27 to demonstrate that both versions of the <code>factorial</code>
procedure now require space that grows linearly with their input.
</p>
</blockquote>

<p>
<b>Answer</b>:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">factorial</span> n)
  (<span style="color: #531ab6;">define</span> (<span style="color: #721045;">iter</span> product counter)
    (<span style="color: #531ab6;">if</span> (<span style="color: #8f0075;">&gt;</span> counter n)
        product
        (iter (<span style="color: #8f0075;">*</span> counter product)
              (<span style="color: #8f0075;">+</span> counter <span style="color: #0000b0;">1</span>))))
  (iter <span style="color: #0000b0;">1</span> <span style="color: #0000b0;">1</span>))


(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">3</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">3</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
ok

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">1</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">70</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">17</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">1</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">2</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">107</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">20</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">2</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">3</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">144</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">23</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">6</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">4</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">181</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">26</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">24</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">5</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">218</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">29</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">120</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">6</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">255</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">32</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">720</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">factorial</span> n)
  (<span style="color: #531ab6;">if</span> (<span style="color: #8f0075;">=</span> n <span style="color: #0000b0;">1</span>)
      <span style="color: #0000b0;">1</span>
      (<span style="color: #8f0075;">*</span> (factorial (<span style="color: #8f0075;">-</span> n <span style="color: #0000b0;">1</span>)) n)))

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">3</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">3</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
ok

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">1</span>
           )

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">18</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">11</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">1</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">2</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">52</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">19</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">2</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">3</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">86</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">27</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">6</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">4</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">120</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">35</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">24</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">5</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">154</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">43</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">120</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(factorial <span style="color: #0000b0;">6</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">188</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">51</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">720</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb9ff239" class="outline-2">
<h2 id="orgb9ff239">Exercise 5.29</h2>
<div class="outline-text-2" id="text-orgb9ff239">
<p>
<b>Exercise</b>:
</p>

<blockquote>
<p>
Monitor the stack operations in the tree-recursive Fibonacci
computation:
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">fib</span> n)
  (<span style="color: #531ab6;">if</span> (&lt; n 2)
      n
      (+ (fib (- n 1)) (fib (- n 2)))))
</pre>
</div>

<p>
a. Give a formula in terms of <code>n</code> for the maximum depth of the stack
required to compute <code>Fib(n)</code> for <code>n &gt;= 2</code>.  Hint: In section 2.2 we
argued that the space used by this process grows linearly with <code>n</code>.
</p>

<p>
b. Give a formula for the total number of pushes used to compute
<code>Fib(n)</code> for <code>n &gt;= 2</code>.  You should find that the number of pushes
(which correlates well with the time used) grows exponentially with
<code>n</code>.  Hint: Let <code>S(n)</code> be the number of pushes used in computing
<code>Fib(n)</code>.  You should be able to argue that there is a formula that
expresses <code>S(n)</code> in terms of <code>S(n - 1)</code>, <code>S(n - 2)</code>, and some fixed
"overhead" constant k that is independent of n.  Give the formula, and
say what <code>k</code> is.  Then show that <code>S(n)</code> can be expressed as
<code>aFib(n + 1) + b</code> and give the values of <code>a</code> and <code>b</code>.
</p>
</blockquote>

<p>
<b>Answer</b>:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(<span style="color: #531ab6;">define</span> (<span style="color: #721045;">fib</span> n)
  (<span style="color: #531ab6;">if</span> (<span style="color: #8f0075;">&lt;</span> n <span style="color: #0000b0;">2</span>)
      n
      (<span style="color: #8f0075;">+</span> (fib (<span style="color: #8f0075;">-</span> n <span style="color: #0000b0;">1</span>)) (fib (<span style="color: #8f0075;">-</span> n <span style="color: #0000b0;">2</span>)))))

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">3</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">3</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
ok

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(fib <span style="color: #0000b0;">2</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">72</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">13</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">1</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(fib <span style="color: #0000b0;">3</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">128</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">18</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">2</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(fib <span style="color: #0000b0;">4</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">240</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">23</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">3</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(fib <span style="color: #0000b0;">5</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">408</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">28</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">5</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(fib <span style="color: #0000b0;">6</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">688</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">33</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">8</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(fib <span style="color: #0000b0;">7</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">1136</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">38</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">13</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(fib <span style="color: #0000b0;">8</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">1864</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">43</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">21</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(fib <span style="color: #0000b0;">9</span>)

(total-pushes <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">3040</span> maximum-depth <span style="color: #8f0075;">=</span> <span style="color: #0000b0;">48</span>)
<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval value:</span>
<span style="color: #0000b0;">34</span>

<span style="color: #595959;">;;; </span><span style="color: #595959;">EC-Eval input:</span>
(fib <span style="color: #0000b0;">10</span>)
</pre>
</div>


<ul class="org-ul">
<li><p>
a.
</p>

<p>
<code>max-depth(fib(n)) = 5n + 8</code>.
</p></li>

<li><p>
b.
</p>

<p>
The first formula is <code>S(n) = S(n-1) + S(n-2) + 40</code>.
</p>

<p>
The second one&#x2026;?
</p></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<div style="text-align: center;"><a href="./posts.html"></a></div><p>Send me an <a href="mailto:giulio.pietroiusti@gmail.com">email</a> for comments.</p> <p>Created with <span class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 30.1.50 (<a href="https://orgmode.org">Org</a> mode 9.7.11)</span></p>
</div>
</body>
</html>
